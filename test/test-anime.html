<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <style type="text/css">
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow: hidden;
        }
        #area{
            position: absolute;
            left: 100px;
            top: 50px;
            height: 80%;
            width: 60%;
            border: 1px solid #000000;
        }
        .comment{
            color: #000000;
            border: 1px solid #FF6600;           
        }
        .fix{
            float:left;
        }

        #play{
            width:50px;
        }        
    </style>
</head>

<body>
    <div id="timer">0</div>
    <button id="play", type=button data-func="play" onclick="play();">start</button>
    <input type="number" id="seek" /><button type=button onclick="seek();">seek</button>
    <div id="area"></div>
</body>

<script>
    // @ts-check
    var anime = require('animejs');
    var comment_elm = require("../comment");
    var NicoComment = require("../nico_comment");
    var util = require("./test_comments");

    // let commnets = util.randomComments(5000, 1.5*1000);
    let commnets = util.sampleComments();
    commnets.sort((a, b) => {
        if (a.vpos < b.vpos) return -1;
        if (a.vpos > b.vpos) return 1;
        return 0;
    });
    console.log("last commnt time ms=", commnets[commnets.length-1].vpos*10);

    let areabyid = document.getElementById("area");
    let elm = document.createElement("div");
    elm.innerHTML = "fix textsssss";
    elm.classList.add("comment", "fix");
    elm.style.opacity = 0;
    areabyid.appendChild(elm);
    elm.style.position = "absolute";
    elm.setAttribute("data-delay", (1000).toString());

    let elm2= document.createElement("div");
    elm2.innerHTML = "fix text2";
    elm2.classList.add("comment", "fix");
    elm2.style.opacity = 0;
    areabyid.appendChild(elm2);
    elm2.style.position = "absolute";
    elm2.style.top = 50 + "px";
    elm2.setAttribute("data-delay", (3000).toString());  

    let ctl_list = make_tl(commnets);
    console.log("ctl_list.length=", ctl_list.length)

    let cutimer = 0;
    let cutimer_id;

    let getCurrentTime = ()=>{
        return cutimer;
    };
    const inv = 100;
    let int_timer=null;
    let test = ()=>{
        ctl_list.forEach((ctl) => {
            if(!ctl.is_play && ctl.mind<=getCurrentTime()){
                console.log("test play=", ctl.is_play, "ctl.mind=", ctl.mind, "cu time=", getCurrentTime());
                ctl.play();
            }
        });        
		if (int_timer) {
			int_timer = setTimeout( ()=> { 
                test(); 
            }, inv);
		}       
    };
    
    let play = ()=>{   
        let btn = document.querySelector('#play');
        if(btn.getAttribute('data-func')=="play"){
            if(int_timer==null){
                int_timer = setTimeout( ()=> { 
                    test(); 
                }, inv);
            }
            cutimer_id = setInterval(()=>{
                const target = document.getElementById("timer");
                target.textContent = cutimer;
                cutimer+=200;
            }, 200);;

            btn.textContent = "pause";
            btn.setAttribute('data-func', "pause");
        }else{
            clearInterval(cutimer_id);
            clearTimeout(int_timer);
            int_timer = null;
            ctl_list.forEach((ctl) => {
                ctl.pause();
            });

            btn.textContent = "play";
            btn.setAttribute('data-func', "play");
        }
    };

    let seek = ()=>{
        const target = document.getElementById("seek");
        const time_ms = parseInt(target.value);
        document.getElementById("timer").textContent = time_ms;
        cutimer = time_ms;

        ctl_list.forEach((ctl) => {
            ctl.seek(time_ms);
        });
    };

    let reset = ()=>{
        cutimer = 0;
        document.getElementById("timer").textContent = cutimer;

        ctl_list.forEach((ctl) => {
            ctl.createFlow();
        });
    }

    let timer;
    const timeout = 200;
    window.addEventListener('resize', () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            reset();
        }, timeout);
    });
</script>

</html>