<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script>
        window.jQuery = window.$ = require("jquery");
    </script>
    <link rel="stylesheet" type="text/css" href="../css/app.css">
    <style type="text/css">
    </style>
</head>

<body>
    <player-viewinfo-page></player-viewinfo-page>
</body>
<script>
    const ipc = require("electron").ipcRenderer;
    // const remote = require("electron").remote;
    const {remote, ipcRenderer} = require("electron");
    var app_base_dir = remote.getGlobal("sharedObj").base_dir; // eslint-disable-line
    const { NicoPlay } = require(`${app_base_dir}/js/niconico_play`);

    var riot = require("riot"); // eslint-disable-line
    var obs = riot.observable(); // eslint-disable-line

    require(`${app_base_dir}/tags/player-viewinfo-page.tag`);
    riot.mount("player-viewinfo-page");
    
    ipc.on("request-send-video-data", (event, arg) => {
        console.log("request-send-video-data", arg);
        const video_data = arg.video_data;
        const viweinfo = arg.viweinfo;
        document.title = viweinfo.thumb_info.title;
        obs.trigger("on_set_player_state", "play"); 
        obs.trigger("receivedData", video_data);
        obs.trigger("on_load_player_tags", viweinfo.thumb_info.tags);
        obs.trigger("on_change_viweinfo", viweinfo);
    });

    ipc.on("request-send-videoid", (event, video_id) => {
        const noco_play = new NicoPlay();
        noco_play.play(video_id, (state)=>{
            // state_log += state + ":";
            console.log(state);
        }).then((result)=>{
            const {nico_cookies, comments, thumb_info, video_url} = result;
            const ret = ipcRenderer.sendSync("set-nicohistory", nico_cookies);
            if(ret=="ok"){
                const video_data = {
                    src: video_url,
                    type: thumb_info.video_type,
                    commnets: comments
                };
                const viweinfo = {
                    thumb_info:thumb_info,
                    commnets: comments
                };
                document.title = viweinfo.thumb_info.title;
                obs.trigger("on_set_player_state", "play"); 
                obs.trigger("receivedData", video_data);
                obs.trigger("on_load_player_tags", viweinfo.thumb_info.tags);
                obs.trigger("on_change_viweinfo", viweinfo);
            }else{
                console.log("set-nicohistory error: ", video_id);
            }
        }).catch(error => {
            console.log(error);
        });
    });

</script>

</html>