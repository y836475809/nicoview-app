<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download</title>
    <script>
        window.jQuery = window.$ = require("jquery");
    </script>
    <!-- <script src="../node_modules/slickgrid/lib/jquery-3.1.0.js"></script> -->
    <script src="../node_modules/slickgrid/lib/jquery.event.drag-2.3.0.js"></script>
    <script src="../node_modules/slickgrid/lib/jquery.event.drop-2.3.0.js"></script>
    <!-- <script src="../node_modules/slickgrid/lib/jquery-ui-1.9.2.js"></script> -->
    <script src="../node_modules/slickgrid/slick.core.js"></script>
    <script src="../node_modules/slickgrid/slick.grid.js"></script>
    <script src="../node_modules/slickgrid/slick.dataview.js"></script>
    <script src="../node_modules/slickgrid/plugins/slick.rowselectionmodel.js"></script>
    <script src="../node_modules/slickgrid/plugins/slick.rowmovemanager.js"></script>
    <link rel="stylesheet" type="text/css" href="../app/css/app.css">
    <!-- <link rel="stylesheet" type="text/css" href="../node_modules/slickgrid/slick.grid.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="../node_modules/slickgrid/css/smoothness/jquery-ui-1.11.3.custom.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="../node_modules/slickgrid/slick-default-theme.css"> -->
    <style type="text/css">
    </style>
</head>

<body>
    <div>
        <div>
            <input id="smlie-low" type="checkbox">low
            <input id="smlie-videoid" type="text">
            <button onclick="onclickLoadSmile();">Smile</button>
            <button onclick="onclickLoadSmileCancel();">cancel</button>
        </div>
        <div>
            <input id="dmc-low" type="checkbox">low
            <input id="dmc-videoid" type="text">
            <button onclick="onclickLoadDmc();">Dmc</button>
            <button onclick="onclickLoadDmcCancel();">cancel</button>
        </div>
    </div>
    <button onclick="onclickStartTimer();">start</button>
    <button onclick="onclickStopTimer();">stop</button>
    <div id="myGrid" style="width:100%;height:500px;"></div>
</body>

<script>

    const options = {
        enableCellNavigation: true,
        // enableColumnReorder: true,
        enableColumnReorder: false,
    };

    let grid = null;
    let dataView = null;
    const columns = [
        {id: "title", name: "Title", field: "title", behavior: "selectAndMove" },
        {id: "param1", name: "Data1", field: "param1", behavior: "selectAndMove" },
        {id: "param2", name: "Data2", field: "param2", behavior: "selectAndMove" },
    ];
    let data = [
        {id: "id1", title: "Item1", param1: "123", param2: "abc"},
        {id: "id2", title: "Item2", param1: "345", param2: "def"},
        {id: "id3", title: "Item3", param1: "678", param2: "ghi"},
        {id: "id4", title: "Item4", param1: "098", param2: "jkl"},
        {id: "id5", title: "Item5", param1: "098", param2: "jll"},
    ];

    $(function () {
        dataView = new Slick.Data.DataView();
        dataView.onRowCountChanged.subscribe((e, args) => {
            grid.updateRowCount();
            grid.render();
        });

        dataView.onRowsChanged.subscribe((e, args) => {
            grid.invalidateRows(args.rows);
            grid.render();
        });
        // grid = new Slick.Grid("#myGrid", data, columns, options);
        grid = new Slick.Grid("#myGrid", dataView, columns, options);

        grid.setSelectionModel(new Slick.RowSelectionModel());

        const moveRowsPlugin = new Slick.RowMoveManager({
            cancelEditOnDrag: true
        });

        moveRowsPlugin.onBeforeMoveRows.subscribe(function (e, data) {
            for (let i = 0; i < data.rows.length; i++) {
                // no point in moving before or after itself
                if (data.rows[i] == data.insertBefore || data.rows[i] == data.insertBefore - 1) {
                    e.stopPropagation();
                    return false;
                }
            }
            return true;
        });

        moveRowsPlugin.onMoveRows.subscribe(function (e, args) {
            let extractedRows = [], left, right;
            const rows = args.rows;
            const insertBefore = args.insertBefore;
            left = data.slice(0, insertBefore);
            right = data.slice(insertBefore, data.length);

            rows.sort(function(a,b) { return a-b; });

            for (let i = 0; i < rows.length; i++) {
                extractedRows.push(data[rows[i]]);
            }

            rows.reverse();

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                if (row < insertBefore) {
                    left.splice(row, 1);
                } else {
                    right.splice(row - insertBefore, 1);
                }
            }

            data = left.concat(extractedRows.concat(right));

            const selectedRows = [];
            for (let i = 0; i < rows.length; i++)
                selectedRows.push(left.length + i);

            grid.resetActiveCell();
            // grid.setData(data);
            // grid.setSelectedRows(selectedRows);
            // grid.render();
            dataView.beginUpdate();
            dataView.setItems(data);
            dataView.endUpdate();

            grid.setSelectedRows(selectedRows);
        });

        grid.registerPlugin(moveRowsPlugin);

        dataView.beginUpdate();
        dataView.setItems(data);
        dataView.endUpdate();
    });


    const ff = async (count, on_progress) => {
        for (let index = 0; index < count; index++) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            // on_progress(`${index}/${count}`);
            on_progress(`${index}/${count}`);
        }   
    };
    const ff2 = async (count, on_progress) => {
        for (let index = count; index >= 0; index--) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            // on_progress(`${index}/${count}`);
            on_progress(`wait ${index}`);
        }   
    };

    let d_cancel = false;
    
    const onclickStartTimer = async ()=>{
        const column_index = grid.getColumnIndex("param2");

        const did = [];
        let data_index = 0;
        let oo = dataView.getItemByIdx(data_index);
        let id = oo.id;
        const ll = dataView.getLength();
        for (let index = 0; index < ll; index++) {

            if(!did.includes(id)){ 
                if(d_cancel){
                    data_index = dataView.getRowById(id);
                    oo.param2 = "cancel";
                    grid.updateCell(data_index, column_index);                   
                    break;
                }        
                await ff2(5, (state)=>{ 
                    data_index = dataView.getRowById(id);
                    oo.param2 = state;
                    grid.updateCell(data_index, column_index);
                });
                await ff(5, async (state)=>{ 
                    data_index = dataView.getRowById(id);
                    oo.param2 = `${id}: ${state}`; 
                    grid.updateCell(data_index, column_index);
                });
                did.push(id);
            }
            data_index++;
            if(data_index>=dataView.getLength()){
                break;
            }
            oo = dataView.getItemByIdx(data_index);
            id = oo.id;
        }
    };
    const onclickStopTimer = async ()=>{
        d_cancel = true;
    };

    const { NicoNicoDownloader } = require("../app/js/niconico-downloader");

    let smile_downlader = null;
    const onclickLoadSmile = async ()=>{
        const video_id = document.getElementById("smlie-videoid").value;
        const low_ok = document.getElementById("smlie-low").checked;

        smile_downlader = new NicoNicoDownloader(video_id, "./", !low_ok);
        const result =await smile_downlader.download((state)=>{
            console.log("progress: ", state);
        });
        console.log("result: ", result);
    }; 
    const onclickLoadSmileCancel = ()=>{
        if(smile_downlader){
            smile_downlader.cancel();
        }
    };

    let dmc_downlader = null;
    const onclickLoadDmc = async ()=>{
        const video_id = document.getElementById("dmc-videoid").value;
        const low_ok = document.getElementById("dmc-low").checked;

        dmc_downlader = new NicoNicoDownloader(video_id, "./", !low_ok);
        const result = await dmc_downlader.download((state)=>{
            console.log("progress: ", state);
        });
        console.log("result: ", result);
    };  

    const onclickLoadDmcCancel = async ()=>{
        if(dmc_downlader){
            dmc_downlader.cancel();
        }
    };
</script>

</html>