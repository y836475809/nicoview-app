<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download</title>
    <script>
        window.jQuery = window.$ = require("jquery");
    </script>
    <script src="../node_modules/riot/riot+compiler.min.js"></script>
    <!-- <script src="../node_modules/slickgrid/lib/jquery-3.1.0.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/lib/jquery.event.drag-2.3.0.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/lib/jquery.event.drop-2.3.0.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/lib/jquery-ui-1.9.2.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/slick.core.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/slick.grid.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/slick.dataview.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/plugins/slick.rowselectionmodel.js"></script> -->
    <!-- <script src="../node_modules/slickgrid/plugins/slick.rowmovemanager.js"></script> -->
    <link rel="stylesheet" type="text/css" href="../app/css/app.css">
    <!-- <link rel="stylesheet" type="text/css" href="../node_modules/slickgrid/slick.grid.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="../node_modules/slickgrid/css/smoothness/jquery-ui-1.11.3.custom.css"> -->
    <!-- <link rel="stylesheet" type="text/css" href="../node_modules/slickgrid/slick-default-theme.css"> -->
    <style type="text/css">
        .cn {
            display: flex;
        }
        .page {
            border: 1px solid #000000;
            /* width: 100%;
            height: 100%; */
            width: 50%;
        }
    </style>
</head>

<body>
    <div>
        <div>
            <input id="smlie-low" type="checkbox">low
            <input id="smlie-videoid" type="text">
            <button onclick="onclickLoadSmile();">Smile</button>
            <button onclick="onclickLoadSmileCancel();">cancel</button>
        </div>
        <div>
            <input id="dmc-low" type="checkbox">low
            <input id="dmc-videoid" type="text">
            <button onclick="onclickLoadDmc();">Dmc</button>
            <button onclick="onclickLoadDmcCancel();">cancel</button>
        </div>
    </div>
    <button onclick="onclickStartTimer();">start</button>
    <button onclick="onclickStopTimer();">stop</button>
    <!-- <div id="myGrid" style="width:100%;height:500px;"></div> -->
    <div class="cn">
        <download-page class="page"></download-page>
        <library-page class="page"></library-page>
    </div>
</body>

<script>
    /* globals $ */
    const path = require("path");
    const remote = require("electron").remote;
    const shared_obj = remote.getGlobal("sharedObj");
    var app_base_dir = shared_obj.base_dir;  // eslint-disable-line
    var riot = require("riot");  // eslint-disable-line
    var obs = riot.observable(); // eslint-disable-line

    require(`${app_base_dir}/tags/download-page`);
    require(`${app_base_dir}/tags/library-page`);
    riot.mount("download-page");
    riot.mount("library-page");

    let data = [
        {thumb_img:"", id: "sm10", name: "Item1", progress: ""},
        {thumb_img:"", id: "sm20", name: "Item2", progress: ""},
        {thumb_img:"", id: "sm30", name: "Item3", progress: ""},
        {thumb_img:"", id: "sm40", name: "Item4", progress: ""},
        {thumb_img:"", id: "sm50", name: "Item5", progress: ""},
    ];

    obs.trigger("set-download-items", data);
    
    let is_cancel = false;
    const onclickStartTimer = async ()=>{
        obs.trigger("start-download", async (video_id, on_progress)=>{
            const count = 5;
            for (let index = 0; index < count; index++) {
                if(is_cancel){
                    break;
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
                on_progress(`${index}/${count}`);
            }  
            if(is_cancel){
                return "cancel";
            }

            //TODO
            const item = {
                _data_type:"video", 
                _db_type:"json", 
                dirpath: path.joint(app_base_dir, "data"),
                video_id: video_id,
                video_name: `title ${video_id}`,
                video_filename: `${video_id}.mp4`,
                video_type: "mp4",
                max_quality: true,
                time: 600,
                pub_date: new Date().getTime(),
                tags: ["tag1", "tag2"]
            };
            obs.trigger("add-library-item", item);
            return "ok";
        });
    };
    const onclickStopTimer = async ()=>{
        is_cancel = true;
        obs.trigger("cancel-download");
    };

    const { NicoNicoDownloader } = require("../app/js/niconico-downloader");

    let smile_downlader = null;
    const onclickLoadSmile = async ()=>{
        const video_id = document.getElementById("smlie-videoid").value;
        const low_ok = document.getElementById("smlie-low").checked;

        smile_downlader = new NicoNicoDownloader(video_id, "./", !low_ok);
        const result =await smile_downlader.download((state)=>{
            console.log("progress: ", state);
        });
        console.log("result: ", result);
    }; 
    const onclickLoadSmileCancel = ()=>{
        if(smile_downlader){
            smile_downlader.cancel();
        }
    };

    let dmc_downlader = null;
    const onclickLoadDmc = async ()=>{
        const video_id = document.getElementById("dmc-videoid").value;
        const low_ok = document.getElementById("dmc-low").checked;

        dmc_downlader = new NicoNicoDownloader(video_id, "./", !low_ok);
        const result = await dmc_downlader.download((state)=>{
            console.log("progress: ", state);
        });
        console.log("result: ", result);
    };  

    const onclickLoadDmcCancel = async ()=>{
        if(dmc_downlader){
            dmc_downlader.cancel();
        }
    };

    const timeout = 200;
    let timer;
    window.addEventListener("resize", () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            obs.trigger("resizeEndEvent", {
                width: $("#cn").height,
                height: $("#cn").width
            });
        }, timeout);
    });
</script>

</html>