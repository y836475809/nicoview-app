<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <style type="text/css">
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow: hidden;
        }
        #area{
            position: relative;
            left: 100px;
            top: 50px;
            height: 80%;
            width: 70%;
            border: 1px solid #000000;
        }
        .comment{
            float:left;
            color: #000000;
            border: 1px solid #FF6600;
        }
    </style>
</head>

<body>
    <button type=button onclick="play2();">start</button>
    <button type=button onclick="pause();">pause</button>
    <input type="number" id="seek" /><button type=button onclick="seek();">seek</button>
    <div id="area"></div>
</body>

<script>
    let self = this;
    var anime = require('animejs');
    var comment_elm = require("../comment");
    var nico_comment = require("../nico_comment");

    let commnets = [
        { no: 1, vpos: 100, text: "AAAAA AAAAAAAAAA" },
        { no: 2, vpos: 250, text: "AAAAA" },
        { no: 3, vpos: 300, text: "AAAAAAAAAAAAAAA "},
        { no: 4, vpos: 450, text: "0" }
    ];

    let nc_elms = [];
    let nc_params = [];
    const parent_id = "area";
    let area = document.querySelector("#area");
    const width = area.clientWidth;
    const duration = 5000;
    
    let cm_elm = new comment_elm(parent_id, width, duration);
    commnets.forEach((cm) => {
        const no = cm.no;
        const text = cm.text;
        const delay = cm.vpos*10;
        ret = cm_elm.cretae_flow(no, text, delay);
        nc_elms.push(ret.ele);
        nc_params.push(ret.params);

    });

    const num = 12;
    let cm = new nico_comment(num);
    cm.width = width;
    cm.comments = nc_params;
    cm.calc_comment();

    let lanes_map;
    let calc_cms = cm.comments;
    calc_cms.forEach((cm, index) => {
        let em = nc_elms[index];
        // em.style.opacity = 0;
        em.classList.add("flow");
        em.style.position = "absolute";
        em.style.top = (cm.lane_index * 50) + "px";
    });

    let createAnime = ()=>
    {
        
    };

    // self.comment_anime = anime({
    //     targets: '.flow',
    //     translateX: function (el) {
    //         console.log("eww =", area.clientWidth + el.getBoundingClientRect().width);
    //         return -(area.clientWidth + el.getBoundingClientRect().width);
    //         // return el.getAttribute('data-x');
    //     },
    //     duration: function (target) {
    //         return duration;
    //     },
    //     delay: function (target, index) {
    //         return target.getAttribute('data-delay');
    //     },
    //     easing: 'linear',
    //     loop: false,
    //     autoplay: false
    // });
    
    // var TLflow = anime.timeline({
    //     targets: '.comment.flow',
    //     delay: function(el, i) {
    //         return el.getAttribute('data-delay');
    //     },

    //     easing: 'linear',
    //     loop: false,
    //     autoplay: false
    // });

    // TLflow
    //     .add({
    //         opacity: [1, 1],
    //         duration: 1,
    //     })
    //     .add({
    //         opacity: 1,
    //     })
        // .add({
        //     // opacity: [1, 0],
        //     opacity:0,
        //     duration: 1,
        //     offset: 5100,
        //     // offset: 5000,
        //     // offset: '+=3000'
        //     // display: 'none',
        //     // visibility : "hidden"
        // });
    //let area_w = document.querySelector("#area").clientWidth;
    let areabyid = document.getElementById("area");
    let elm = document.createElement("div");
    elm.innerHTML = "fix textsssss";
    elm.classList.add("comment", "fix");
    // elm.id = "elm1";
    // elm.style.display = 'none';
    // elm.style.visibility = "hidden";
    // elm.style.opacity = 0;
    areabyid.appendChild(elm);
    let el1_w = elm.getBoundingClientRect();
    elm.style.position = "absolute";
    elm.style.left = width + "px";
    elm.style.width = el1_w.width + "px";
    elm.setAttribute("data-x", (100).toString());
    elm.setAttribute("data-delay", (1000).toString());

    let elm2= document.createElement("div");
    elm2.innerHTML = "fix text2";
    elm2.classList.add("comment", "fix");
    elm2.id = "elm2";
    // elm2.style.display = 'none';
    // elm2.style.visibility = "hidden";
    // elm2.style.opacity = 0;
    areabyid.appendChild(elm2);
    let el2_w = elm2.getBoundingClientRect();
    elm2.style.position = "absolute";
    elm2.style.left = width + "px";
    elm2.style.width = el2_w.width+ "px";
    elm2.style.top = 50 + "px";
    elm2.setAttribute("data-x", (100).toString());
    elm2.setAttribute("data-delay", (3000).toString());

    
    var TLParamsInheritance = anime.timeline({
        // targets: '.comment.fix',
        targets: '.fix',
        translateX: function (el, i) {
            return [
            width-parseInt(el.style.left),
                 //0,
                -(width + el.getBoundingClientRect().width)
            ];
            // console.log("el =", el, ", i=", i);
            // return [300, 100];
        },
        delay: function(el, i) {
            return el.getAttribute('data-delay');
        },
        easing: 'linear',
        duration: 3000,
        // easing: 'easeOutExpo',
        // direction: 'alternate',
        loop: false,
        autoplay: false
    });

    TLParamsInheritance
        .add({
            translateX: 0,
            translateY: 0,
            opacity: [1, 1],
            // delay:1,
            duration: 1,
        })
        .add({
            translateY: 0,
            opacity: 1,
            // duration: 5000,
        })
        .add({
            translateX: 0,
            translateY: 0,
            opacity: [1, 0],
            duration: 1,
            // delay:1
            // offset: 3000,
        });

    // self.comment_anime.pause();
    // self.comment_anime.reset();
    // anime.remove('.comment');

    let play2 = ()=>{
        //self.comment_anime.play();
        //TLflow.play();
        TLParamsInheritance.play();
    };

    let pause = ()=>{
        //self.comment_anime.pause();
        //TLflow.pause();
        TLParamsInheritance.pause();
    };

    let seek = ()=>{
        const target = document.getElementById("seek");
        const time_ms = parseInt(target.value);

        //self.comment_anime.seek(time_ms);
        //TLflow.seek(time_ms);
        TLParamsInheritance.seek(time_ms);
    };

    let rr = ()=>{
        let area = document.querySelector("#area");
        const width = area.clientWidth;

        TLParamsInheritance.reset();
        anime.remove(".flow");
        let elms = document.querySelectorAll('.flow');
        for(i=0; i<elms.length; i++){
            elms[i].style.left = width + "px";
        }

        TLParamsInheritance = anime.timeline({
        // targets: '.comment.fix',
        targets: '.fix',
        translateX: function (el, i) {
            return [
            width-parseInt(el.style.left),
                 //0,
                -(width + el.getBoundingClientRect().width)
            ];
            // console.log("el =", el, ", i=", i);
            // return [300, 100];
        },
        delay: function(el, i) {
            return el.getAttribute('data-delay');
        },
        easing: 'linear',
        duration: 3000,
        // easing: 'easeOutExpo',
        // direction: 'alternate',
        loop: false,
        autoplay: false
    });

    TLParamsInheritance
        .add({
            translateX: 0,
            translateY: 0,
            opacity: [1, 1],
            // delay:1,
            duration: 1,
        })
        .add({
            translateY: 0,
            opacity: 1,
            // duration: 5000,
        })
        .add({
            translateX: 0,
            translateY: 0,
            opacity: [1, 0],
            duration: 1,
            // delay:1
            // offset: 3000,
        });
    //     self.comment_anime.pause();
    //     self.comment_anime.reset();

    //     anime.remove(".flow");
    //     let area_w = document.querySelector("#area").clientWidth;
    //     let elms = document.querySelectorAll('.flow');
    //     for(i=0; i<elms.length; i++){
    //         elms[i].style.left = area_w + "px";
    //     }

    //     self.comment_anime = anime({
    //     targets: '.flow',
    //     translateX:  (el)=> {
    //         return -(area_w + el.getBoundingClientRect().width);
    //         // return [
    //         //      area_w-parseInt(el.style.left),
    //         //     -(area_w + el.getBoundingClientRect().width)
    //         // ];
    //         // return el.getAttribute('data-x');
    //     },
    //     duration: function (target) {
    //         return 5000;
    //     },
    //     delay: function (target, index) {
    //         return target.getAttribute('data-delay');
    //     },
    //     easing: 'linear',
    //     loop: false,
    //     autoplay: false
    //     });

    //     TLflow = anime.timeline({
    //     targets: '.comment.flow',
    //     delay: function(el, i) {
    //         return el.getAttribute('data-delay');
    //     },

    //     easing: 'linear',
    //     loop: false,
    //     autoplay: false
    // });

    // TLflow
    //     .add({
    //         opacity: [1, 1],
    //         duration: 1,

    //     })
    //     .add({
    //         opacity: 1,

    //     });
    }

    let timer;
    const timeout = 200;
    window.addEventListener('resize', () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            rr();
        }, timeout);       
    });
</script>

</html>