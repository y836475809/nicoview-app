<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <style type="text/css">
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            overflow: hidden;
        }
        #area{
            position: absolute;
            left: 100px;
            top: 50px;
            height: 80%;
            width: 60%;
            border: 1px solid #000000;
        }
        .comment{
            /* float:left; */
            color: #000000;
            border: 1px solid #FF6600;
            /* display:inline; */
            /* white-space: nowrap */
        }
        .fix{
            float:left;
            /* color: #000000; */
            /* border: 1px solid #FF6600; */
        }
    </style>
</head>

<body>
    <button type=button onclick="play();">start</button>
    <button type=button onclick="pause();">pause</button>
    <input type="number" id="seek" /><button type=button onclick="seek();">seek</button>
    <div id="area"></div>
</body>

<script>
    // @ts-check
    var anime = require('animejs');
    var comment_elm = require("../comment");
    var nico_comment = require("../nico_comment");

    let commnets = [
        { no: 1, vpos: 0, text: "AAAAA AAAAAAAAAA" },
        { no: 2, vpos: 250, text: "AAAAA" },
        { no: 3, vpos: 300, text: "AAAAAAAAAAAAAAA "},
        { no: 4, vpos: 450, text: "0" }
    ];

    const parent_id = "area";
    let area = document.querySelector("#area");
    const width = area.clientWidth;
    const duration = 5000;
    
    let cm_elm = new comment_elm(parent_id, width, duration);
    let flow_params = [];
    commnets.forEach((cm) => {
        const no = cm.no;
        const text = cm.text;
        const delay = cm.vpos*10;
        flow_params.push(cm_elm.createFlowElm(text, no, delay));
    });

    const num = 12;
    let cm = new nico_comment(num);
    cm.width = width;
    cm.comments = flow_params;
    cm.calc_comment();

    cm.comments.forEach((cm, index) => {
        cm.elm.setAttribute("data-rowindex", (cm.lane_index).toString());
    });

    let areabyid = document.getElementById("area");
    let elm = document.createElement("div");
    elm.innerHTML = "fix textsssss";
    elm.classList.add("comment", "fix");
    elm.style.opacity = 0;
    areabyid.appendChild(elm);
    elm.style.position = "absolute";
    elm.setAttribute("data-delay", (1000).toString());

    let elm2= document.createElement("div");
    elm2.innerHTML = "fix text2";
    elm2.classList.add("comment", "fix");
    elm2.style.opacity = 0;
    areabyid.appendChild(elm2);
    elm2.style.position = "absolute";
    elm2.style.top = 50 + "px";
    elm2.setAttribute("data-delay", (3000).toString());  

    class CommemtTimeLine{
        /**
         * @param {string} parent_selector
         * @param {{selector: string, duration: number}} flow_params
         * @param {{selector: string, duration: number}} fix_params
         */
        constructor(parent_selector, flow_params, fix_params) {
            this.parent_selector = parent_selector;
            this.flow_params = flow_params;
            this.fix_params = fix_params;
            this.flow_timeline = null;
            this.fix_timeline = null;
        }

        createFlow(){
            const selector = this.flow_params.selector;
            const duration = this.flow_params.duration;

            if(this.flow_timeline != null){
                this.flow_timeline.pause();
                this.flow_timeline.reset();
                anime.remove(selector);
            }

            const area = document.querySelector(this.parent_selector);
            const area_width = area.clientWidth;
            let elms = document.querySelectorAll(selector);
            elms.forEach((elm)=>{
                // elm.style.opacity = 0;
                elm.style.left = area_width + "px";
                const rowindex = parseInt(elm.getAttribute('data-rowindex'));
                elm.style.top = (rowindex * 50) + "px";
            });

            this.flow_timeline = anime.timeline({
                targets: selector,
                translateX: (el, i) => {
                    return -(area_width + el.getBoundingClientRect().width);
                },
                delay: (el, i) => {
                    return el.getAttribute('data-delay');
                },
                easing: 'linear',
                duration: duration,
                loop: false,
                autoplay: false
            });

            this.flow_timeline
            .add({
                translateX: 0,
                translateY: 0,
                opacity: 1,
                duration: 1
            })
            .add({
                translateY: 0,
                opacity: 1 
            });
        }

        createFix(){
            const selector = this.fix_params.selector;
            const duration = this.fix_params.duration;

            if(this.fix_timeline != null){
                this.fix_timeline.pause();
                this.fix_timeline.reset();
                anime.remove(selector);
            }

            const area = document.querySelector(this.parent_selector);
            const area_width = area.clientWidth;
           
            let elms = document.querySelectorAll(selector);
            elms.forEach((elm)=>{
                elm.style.opacity = 0;
                const elm_rect = elm.getBoundingClientRect();
                elm.style.left = (area_width/2 - elm_rect.width/2) + "px";
            });

            this.fix_timeline = anime.timeline({
                targets: selector,
                delay: (el, i) => {
                    return el.getAttribute('data-delay');
                },
                // easing: 'linear',
                // duration: duration,
                loop: false,
                autoplay: false
            });

            this.fix_timeline
            .add({
                opacity: 1,
                duration: 1
            })
            .add({
                // opacity: 1,
                duration: duration
            })
            .add({
                opacity: 0,
                duration: 1,
            }); 
  
        }

        play(){
            if(!this._hasTimeline()) return;
            
            this.flow_timeline.play();
            this.fix_timeline.play();
        }

        pause(){
            if(!this._hasTimeline()) return;

            this.flow_timeline.pause();
            this.fix_timeline.pause();
        }

        seek(time_ms){
            if(!this._hasTimeline()) return;

            this.flow_timeline.seek(time_ms);
            this.fix_timeline.seek(time_ms);
        }

        _hasTimeline(){
            if(this.flow_timeline == null) return false;
            if(this.fix_timeline == null) return false;
            
            return true;
        }
    };

    let ctl = new CommemtTimeLine("#area", 
        {selector: ".flow", duration: 5000}, 
        {selector: ".fix", duration: 3000});
    ctl.createFlow();
    ctl.createFix();

    let play = ()=>{
        ctl.play();
    };

    let pause = ()=>{
        ctl.pause();
    };

    let seek = ()=>{
        const target = document.getElementById("seek");
        const time_ms = parseInt(target.value);
        ctl.seek(time_ms);
    };

    let reset = ()=>{
        ctl.createFlow();
        ctl.createFix();
    }

    let timer;
    const timeout = 200;
    window.addEventListener('resize', () => {
        clearTimeout(timer);
        timer = setTimeout(() => {
            reset();
        }, timeout);       
    });
</script>

</html>